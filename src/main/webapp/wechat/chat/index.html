<!DOCTYPE html>
<html>
<head>
<title></title>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="../../static/css/wechat/index.css" rel="stylesheet" />
</head>
<body>
<div class="main" style="background:#EEEEEE;width: 100%;">
    <div class="main_inner clearfix">
        <div class="panel"></div>
        <div id="chatArea" class="box chat">
            <div class="box_hd"></div>
            <div class="box_bd" id="messageList">
            </div>
            <div class="box_ft">
                <div class="box_ft_bd hide">
                    <div class="emoji_panel">
                        <ul class="exp_hd">
                            <li class="exp_hd_item active" data-i="0">
                                <a href="javascript:;">QQ表情</a>
                            </li>
<!--                       <li class="exp_hd_item" data-i="1">
                                <a href="javascript:;">符号表情</a>
                            </li>
                            <li class="exp_hd_item" data-i="2">
                                <a href="javascript:;">动画表情</a>
                            </li> -->
                        </ul>
                        <div class="exp_bd">
                            <div class="exp_cont active">
                            	<button title="微笑" type="qq" class="qqface qqface0">微笑</button>
                               	<button title="撇嘴" type="qq" class="qqface qqface1">撇嘴</button>
                               	<button title="色"  type="qq" class="qqface qqface2">色</button> 
                                <button title="发呆" type="qq" class="qqface qqface3">发呆</button> 
                                <button title="得意" type="qq" class="qqface qqface4">得意</button> 
                                <button title="流泪" type="qq" class="qqface qqface5">流泪</button> 
                                <button title="害羞" type="qq" class="qqface qqface6">害羞</button> 
                                <button title="闭嘴" type="qq" class="qqface qqface7">闭嘴</button> 
                                <button title="睡" type="qq" class="qqface qqface8">睡</button> 
                                <button title="大哭" type="qq" class="qqface qqface9">大哭</button> 
                                <button title="尴尬" type="qq" class="qqface qqface10">尴尬</button> 
                                <button title="发怒" type="qq" class="qqface qqface11">发怒</button> 
                                <button title="调皮" type="qq" class="qqface qqface12">调皮</button> 
                                <button title="呲牙" type="qq" class="qqface qqface13">呲牙</button> 
                                <button title="惊讶" type="qq" class="qqface qqface14">惊讶</button> 
                                
                               	<button title="难过" type="qq" class="qqface qqface15">难过</button> 
                                <button title="酷" type="qq" class="qqface qqface16">酷</button> 
                                <button title="冷汗" type="qq" class="qqface qqface17">冷汗</button> 
                                <button title="抓狂" type="qq" class="qqface qqface18">抓狂</button> 
                                <button title="吐" type="qq" class="qqface qqface19">吐</button> 
                                <button title="偷笑" type="qq" class="qqface qqface20">偷笑</button> 
                                <button title="愉快" type="qq" class="qqface qqface21">愉快</button> 
                                <button title="白眼" type="qq" class="qqface qqface22">白眼</button> 
                                <button title="傲慢" type="qq" class="qqface qqface23">傲慢</button> 
                                <button title="饥饿" type="qq" class="qqface qqface24">饥饿</button> 
                                <button title="困" type="qq" class="qqface qqface25">困</button> 
                                <button title="惊恐" type="qq" class="qqface qqface26">惊恐</button> 
                                <button title="流汗" type="qq" class="qqface qqface27">流汗</button> 
                                <button title="憨笑" type="qq" class="qqface qqface28">憨笑</button> 
                                <button title="悠闲" type="qq" class="qqface qqface29">悠闲</button> 
                                
                                <button title="奋斗" type="qq" class="qqface qqface30">奋斗</button> 
                                <button title="咒骂" type="qq" class="qqface qqface31">咒骂</button> 
                                <button title="疑问" type="qq" class="qqface qqface32">疑问</button> 
                                <button title="嘘" type="qq" class="qqface qqface33">嘘</button> 
                                <button title="晕" type="qq" class="qqface qqface34">晕</button> 
                                <button title="疯了" type="qq" class="qqface qqface35">疯了</button> 
                                <button title="衰" type="qq" class="qqface qqface36">衰</button> 
                                <button title="骷髅" type="qq" class="qqface qqface37">骷髅</button> 
                                <button title="敲打" type="qq" class="qqface qqface38">敲打</button> 
                                <button title="再见" type="qq" class="qqface qqface39">再见</button> 
                                <button title="擦汗" type="qq" class="qqface qqface40">擦汗</button> 
                                <button title="抠鼻" type="qq" class="qqface qqface41">抠鼻</button> 
                                <button title="鼓掌" type="qq" class="qqface qqface42">鼓掌</button> 
                                <button title="糗大了" type="qq" class="qqface qqface43">糗大了</button> 
                                <button title="坏笑" type="qq" class="qqface qqface44">坏笑</button> 
                                 
                                <button title="左哼哼" type="qq" class="qqface qqface45">左哼哼</button> 
                                <button title="右哼哼" type="qq" class="qqface qqface46">右哼哼</button> 
                                <button title="哈欠" type="qq" class="qqface qqface47">哈欠</button> 
                                <button title="鄙视" type="qq" class="qqface qqface48">鄙视</button> 
                                <button title="委屈" type="qq" class="qqface qqface49">委屈</button> 
                                <button title="快哭了" type="qq" class="qqface qqface50">快哭了</button> 
                                <button title="阴险" type="qq" class="qqface qqface51">阴险</button> 
                                <button title="亲亲" type="qq" class="qqface qqface52">亲亲</button> 
                                <button title="吓" type="qq" class="qqface qqface53">吓</button> 
                                <button title="可怜" type="qq" class="qqface qqface54">可怜</button> 
                                <button title="菜刀" type="qq" class="qqface qqface55">菜刀</button> 
                                <button title="西瓜" type="qq" class="qqface qqface56">西瓜</button> 
                                <button title="啤酒" type="qq" class="qqface qqface57">啤酒</button> 
                                <button title="篮球" type="qq" class="qqface qqface58">篮球</button> 
                                <button title="乒乓" type="qq" class="qqface qqface59">乒乓</button> 
                               
                                <button title="咖啡" type="qq" class="qqface qqface60">咖啡</button> 
                                <button title="饭" type="qq" class="qqface qqface61">饭</button> 
                                <button title="猪头" type="qq" class="qqface qqface62">猪头</a> 
                                <button title="玫瑰" type="qq" class="qqface qqface63">玫瑰</button> 
                                <button title="凋谢" type="qq" class="qqface qqface64">凋谢</button> 
                                <button title="嘴唇" type="qq" class="qqface qqface65">嘴唇</button> 
                                <button title="爱心" type="qq" class="qqface qqface66">爱心</button> 
                                <button title="心碎" type="qq" class="qqface qqface67">心碎</button> 
                                <button title="蛋糕" type="qq" class="qqface qqface68">蛋糕</button> 
                                <button title="闪电" type="qq" class="qqface qqface69">闪电</button> 
                                <button title="炸弹" type="qq" class="qqface qqface70">炸弹</button> 
                                <button title="刀" type="qq" class="qqface qqface71">刀</button> 
                                <button title="足球" type="qq" class="qqface qqface72">足球</button> 
                                <button title="瓢虫" type="qq" class="qqface qqface73">瓢虫</button> 
                                <button title="便便" type="qq" class="qqface qqface74">便便</button> 
                                 
                                <button title="月亮" type="qq" class="qqface qqface75">月亮</button> 
                                <button title="太阳" type="qq" class="qqface qqface76">太阳</button> 
                                <button title="礼物" type="qq" class="qqface qqface77">礼物</button> 
                                <button title="拥抱" type="qq" class="qqface qqface78">拥抱</button> 
                                <button title="强" type="qq" class="qqface qqface79">强</button> 
                                <button title="弱" type="qq" class="qqface qqface80">弱</button> 
                                <button title="握手" type="qq" class="qqface qqface81">握手</button> 
                                <button title="胜利" type="qq" class="qqface qqface82">胜利</button> 
                                <button title="抱拳" type="qq" class="qqface qqface83">抱拳</button> 
                                <button title="勾引" type="qq" class="qqface qqface84">勾引</button> 
                                <button title="拳头" type="qq" class="qqface qqface85">拳头</button> 
                                <button title="差劲" type="qq" class="qqface qqface86">差劲</button> 
                                <button title="爱你" type="qq" class="qqface qqface87">爱你</button> 
                                <button title="NO" type="qq" class="qqface qqface88">NO</button> 
                                <button title="OK" type="qq" class="qqface qqface89">OK</button> 
                                 
                                <button title="爱情" type="qq" class="qqface qqface90">爱情</button> 
                                <button title="飞吻" type="qq" class="qqface qqface91">飞吻</button> 
                                <button title="跳跳" type="qq" class="qqface qqface92">跳跳</button>
                                <button title="发抖" type="qq" class="qqface qqface93">发抖</button>
                                <button title="怄火" type="qq" class="qqface qqface94">怄火</button> 
                                <button title="转圈" type="qq" class="qqface qqface95">转圈</button> 
                                <button title="磕头" type="qq" class="qqface qqface96">磕头</button> 
                                <button title="回头" type="qq" class="qqface qqface97">回头</button> 
                                <button title="跳绳" type="qq" class="qqface qqface98">跳绳</button> 
                                <button title="投降" type="qq" class="qqface qqface99">投降</button> 
                                <button title="激动" type="qq" class="qqface qqface100">激动</button> 
                                <button title="乱舞" type="qq" class="qqface qqface101">乱舞</button> 
                                <button title="献吻" type="qq" class="qqface qqface102">献吻</button>
                                <button title="左太极" type="qq" class="qqface qqface103">左太极</button> 
                                <button title="右太极" type="qq" class="qqface qqface104">右太极</button>
                               <!--  <a title="微笑" type="qq" class="qqface qqface0">微笑</a> 
                                <a title="撇嘴" type="qq" class="qqface qqface1">撇嘴</a> 
                                <a title="色" type="qq" class="qqface qqface2">色</a> 
                                <a title="发呆" type="qq" class="qqface qqface3">发呆</a> 
                                <a title="得意" type="qq" class="qqface qqface4">得意</a> 
                                <a title="流泪" type="qq" class="qqface qqface5">流泪</a> 
                                <a title="害羞" type="qq" class="qqface qqface6">害羞</a> 
                                <a title="闭嘴" type="qq" class="qqface qqface7">闭嘴</a> 
                                <a title="睡" type="qq" class="qqface qqface8">睡</a> 
                                <a title="大哭" type="qq" class="qqface qqface9">大哭</a> 
                                <a title="尴尬" type="qq" class="qqface qqface10">尴尬</a> 
                                <a title="发怒" type="qq" class="qqface qqface11">发怒</a> 
                                <a title="调皮" type="qq" class="qqface qqface12">调皮</a> 
                                <a title="呲牙" type="qq" class="qqface qqface13">呲牙</a> 
                                <a title="惊讶" type="qq" class="qqface qqface14">惊讶</a> 
                                
                                
                                <a title="难过" type="qq" class="qqface qqface15">难过</a> 
                                <a title="酷" type="qq" class="qqface qqface16">酷</a> 
                                <a title="冷汗" type="qq" class="qqface qqface17">冷汗</a> 
                                <a title="抓狂" type="qq" class="qqface qqface18">抓狂</a> 
                                <a title="吐" type="qq" class="qqface qqface19">吐</a> 
                                <a title="偷笑" type="qq" class="qqface qqface20">偷笑</a> 
                                <a title="愉快" type="qq" class="qqface qqface21">愉快</a> 
                                <a title="白眼" type="qq" class="qqface qqface22">白眼</a> 
                                <a title="傲慢" type="qq" class="qqface qqface23">傲慢</a> 
                                <a title="饥饿" type="qq" class="qqface qqface24">饥饿</a> 
                                <a title="困" type="qq" class="qqface qqface25">困</a> 
                                <a title="惊恐" type="qq" class="qqface qqface26">惊恐</a> 
                                <a title="流汗" type="qq" class="qqface qqface27">流汗</a> 
                                <a title="憨笑" type="qq" class="qqface qqface28">憨笑</a> 
                                <a title="悠闲" type="qq" class="qqface qqface29">悠闲</a> 
                                
                                <a title="奋斗" type="qq" class="qqface qqface30">奋斗</a> 
                                <a title="咒骂" type="qq" class="qqface qqface31">咒骂</a> 
                                <a title="疑问" type="qq" class="qqface qqface32">疑问</a> 
                                <a title="嘘" type="qq" class="qqface qqface33">嘘</a> 
                                <a title="晕" type="qq" class="qqface qqface34">晕</a> 
                                <a title="疯了" type="qq" class="qqface qqface35">疯了</a> 
                                <a title="衰" type="qq" class="qqface qqface36">衰</a> 
                                <a title="骷髅" type="qq" class="qqface qqface37">骷髅</a> 
                                <a title="敲打" type="qq" class="qqface qqface38">敲打</a> 
                                <a title="再见" type="qq" class="qqface qqface39">再见</a> 
                                <a title="擦汗" type="qq" class="qqface qqface40">擦汗</a> 
                                <a title="抠鼻" type="qq" class="qqface qqface41">抠鼻</a> 
                                <a title="鼓掌" type="qq" class="qqface qqface42">鼓掌</a> 
                                <a title="糗大了" type="qq" class="qqface qqface43">糗大了</a> 
                                <a title="坏笑" type="qq" class="qqface qqface44">坏笑</a> 
                                
                                <a title="左哼哼" type="qq" class="qqface qqface45">左哼哼</a> 
                                <a title="右哼哼" type="qq" class="qqface qqface46">右哼哼</a> 
                                <a title="哈欠" type="qq" class="qqface qqface47">哈欠</a> 
                                <a title="鄙视" type="qq" class="qqface qqface48">鄙视</a> 
                                <a title="委屈" type="qq" class="qqface qqface49">委屈</a> 
                                <a title="快哭了" type="qq" class="qqface qqface50">快哭了</a> 
                                <a title="阴险" type="qq" class="qqface qqface51">阴险</a> 
                                <a title="亲亲" type="qq" class="qqface qqface52">亲亲</a> 
                                <a title="吓" type="qq" class="qqface qqface53">吓</a> 
                                <a title="可怜" type="qq" class="qqface qqface54">可怜</a> 
                                <a title="菜刀" type="qq" class="qqface qqface55">菜刀</a> 
                                <a title="西瓜" type="qq" class="qqface qqface56">西瓜</a> 
                                <a title="啤酒" type="qq" class="qqface qqface57">啤酒</a> 
                                <a title="篮球" type="qq" class="qqface qqface58">篮球</a> 
                                <a title="乒乓" type="qq" class="qqface qqface59">乒乓</a> 
                                
                                <a title="咖啡" type="qq" class="qqface qqface60">咖啡</a> 
                                <a title="饭" type="qq" class="qqface qqface61">饭</a> 
                                <a title="猪头" type="qq" class="qqface qqface62">猪头</a> 
                                <a title="玫瑰" type="qq" class="qqface qqface63">玫瑰</a> 
                                <a title="凋谢" type="qq" class="qqface qqface64">凋谢</a> 
                                <a title="嘴唇" type="qq" class="qqface qqface65">嘴唇</a> 
                                <a title="爱心" type="qq" class="qqface qqface66">爱心</a> 
                                <a title="心碎" type="qq" class="qqface qqface67">心碎</a> 
                                <a title="蛋糕" type="qq" class="qqface qqface68">蛋糕</a> 
                                <a title="闪电" type="qq" class="qqface qqface69">闪电</a> 
                                <a title="炸弹" type="qq" class="qqface qqface70">炸弹</a> 
                                <a title="刀" type="qq" class="qqface qqface71">刀</a> 
                                <a title="足球" type="qq" class="qqface qqface72">足球</a> 
                                <a title="瓢虫" type="qq" class="qqface qqface73">瓢虫</a> 
                                <a title="便便" type="qq" class="qqface qqface74">便便</a> 
                                
                                <a title="月亮" type="qq" class="qqface qqface75">月亮</a> 
                                <a title="太阳" type="qq" class="qqface qqface76">太阳</a> 
                                <a title="礼物" type="qq" class="qqface qqface77">礼物</a> 
                                <a title="拥抱" type="qq" class="qqface qqface78">拥抱</a> 
                                <a title="强" type="qq" class="qqface qqface79">强</a> 
                                <a title="弱" type="qq" class="qqface qqface80">弱</a> 
                                <a title="握手" type="qq" class="qqface qqface81">握手</a> 
                                <a title="胜利" type="qq" class="qqface qqface82">胜利</a> 
                                <a title="抱拳" type="qq" class="qqface qqface83">抱拳</a> 
                                <a title="勾引" type="qq" class="qqface qqface84">勾引</a> 
                                <a title="拳头" type="qq" class="qqface qqface85">拳头</a> 
                                <a title="差劲" type="qq" class="qqface qqface86">差劲</a> 
                                <a title="爱你" type="qq" class="qqface qqface87">爱你</a> 
                                <a title="NO" type="qq" class="qqface qqface88">NO</a> 
                                <a title="OK" type="qq" class="qqface qqface89">OK</a> 
                                
                                <a title="爱情" type="qq" class="qqface qqface90">爱情</a> 
                                <a title="飞吻" type="qq" class="qqface qqface91">飞吻</a> 
                                <a title="跳跳" type="qq" class="qqface qqface92">跳跳</a>
                                <a title="发抖" type="qq" class="qqface qqface93">发抖</a>
                                <a title="怄火" type="qq" class="qqface qqface94">怄火</a> 
                                <a title="转圈" type="qq" class="qqface qqface95">转圈</a> 
                                <a title="磕头" type="qq" class="qqface qqface96">磕头</a> 
                                <a title="回头" type="qq" class="qqface qqface97">回头</a> 
                                <a title="跳绳" type="qq" class="qqface qqface98">跳绳</a> 
                                <a title="投降" type="qq" class="qqface qqface99">投降</a> 
                                <a title="激动" type="qq" class="qqface qqface100">激动</a> 
                                <a title="乱舞" type="qq" class="qqface qqface101">乱舞</a> 
                                <a title="献吻" type="qq" class="qqface qqface102">献吻</a>
                                <a title="左太极" type="qq" class="qqface qqface103">左太极</a> 
                                <a title="右太极" type="qq" class="qqface qqface104">右太极</a> -->
                            </div>
                            <div class="exp_cont emoji_face"></div>
                            <div class="exp_cont tuzki_face"></div>
                        </div>
                    </div>
                </div>
                <div class="box_ft_hd">
                    <a href="javascript:void(0);" class="web_wechat_face" id="web_wechat_face" style="display: block;"></a>
                    <!-- <a href="javascript:void(0);" class="web_wechat_pic" id="web_wechat_pic" style="display: block;" onclick="selectFile();"></a> -->
                    <span class="pictureIcon icon-picture" id="web_wechat_pic" onclick="selectFile();"></span>
                    <form action="<%=contextPath %>/fileUpload" enctype="multipart/form-data" method="post" id="fileForm">
                    	<input id="selectfile" name="selectfile" type="file" accept="*" value="" style="display: none;"/>
                    </form>
                    
                    <a href="javascript:void(0);" class="btn talk_his" id="talk_his" onclick="keywordSelect();">快捷回复</a>
                    &nbsp;
                    <a href="javascript:void(0);" class="btn talk_his" id="talk_his" onclick="newsSelect();">图文信息</a>
                    &nbsp;
                    <a href="javascript:void(0);" class="btn talk_his" id="talk_his" onclick="templateSelect();">模板消息</a>
	                &nbsp;
                    <a href="javascript:void(0);" class="btn talk_his" id="talk_his" onclick="selectList4TopScroll();">聊天记录</a>
                    &nbsp;
                </div>
           
               	<div class="eaitWrap">
                     <pre id="editArea" class="editArea" contenteditable="true"></pre>  
                </div>
             	<div class="bottomGroup">
             		<a href="javascript:void(0);" class="btn btn_send" style="visibility:visible" id="btn_send" onclick="sendMsg();">发 送</a>
             		
             	</div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="../../static/js/wechat/jquery-2.1.4.js"></script>
<script type="text/javascript" src="../../static/plugin/layer-v2.4/layer/layer.js"></script>
<script type="text/javascript" src="../../static/js/wechat/index.js"></script>
<script type="text/javascript" src="../../static/js/kqdsFront/util.js"></script>
<!-- 文本编辑器 -->
<script type="text/javascript">
var downSeqId = null; // 最下面那条
var openid = $.getUrlVar('openid');
var userseqid = $.getUrlVar('userseqid');
var seqId = null;
/** 粉丝信息 **/
var fans_headimgurl = null;
$(function() {
    document.onselectstart = function() {
        // 覆盖Util.js中的onselectstart方法，使其失效
    };

    initFansMsg(); // 初始化粉丝信息
    selectList4TopScroll();

    // 设置表单提交路径
    $("#fileForm").attr("action", "");
    $("#editArea").outerHeight($(".eaitWrap").outerHeight());
});

function initFansMsg() {
    var reqUrl = "WXFansAct/selectPageObjByOpenid.act?openid=" + openid;
    var rtData = getDataFromServer(reqUrl);
    if (rtData.retState == 0) {
        var fansinfo = rtData.fansinfo;
        fans_headimgurl = fansinfo.headimgurl;
    }
}

$("#editArea").on("click", "img",
function() {
    // console.log($(this).focus());
})
/**
 * 点击图片选择事件
 */
function selectFile() {
    $('#selectfile').trigger('click');
}

/**
 * 选择图片后，触发提交表单
 */
$("#selectfile").change(function() {
    var filePath = $("#selectfile").val();
    if ('' != filePath) {
        if (!/\.(gif|jpg|jpeg|png|GIF|JPG|PNG)$/.test(filePath)) {
            alert("图片类型必须是.gif,.jpeg,.jpg,.png中的一种");
            return false;
        }
        subimtFile();
    } else {
        alert("请选择图片");
        return false;
    }
});

/**
 * 上传附件后，回调
 */
function subimtFile() {
    var form = $('#fileForm');
    var options = {
        url: contextPath + "/FileUploadAct/uploadFile.act?module=wechat",
        type: 'post',
        success: function(data) {
            if (data.retState == 0) {
                /** 获取mediaid **/
                var param = {
                    openid: openid,
                    attrId: data.attrId,
                    attrName: data.attrName
                }
                var retrunObj = getDataFromServer("WXReceiveTextAct/getMediaIdAndSendMsg.act", param);
                if (retrunObj.retState == 0) {
                    var msgHtml = getSendMsg4Image(retrunObj);
                    $("#messageList").append(msgHtml); // 发送消息
                    document.getElementById(retrunObj.msgid).scrollIntoView(); // 滚动条到最底部
                    // 清空
                    $("#selectfile").val('');
                }
            }
        }
    };
    form.ajaxSubmit(options);
}

/**
 * 回车自动发送消息
 */
$('#editArea').keydown(function(e) {
    if (e.keyCode == 13) {
        sendMsg();
        /** 发送消息  **/
        // 禁止换行
        e.cancelBubble = true;
        e.preventDefault();
        e.stopPropagation();
    }
});

/**
 * 发送消息
 */
function sendMsg() {
    var timestamp = new Date().getTime();
    var inputText = $("#editArea").html(); // 获取发送内容
    if ('' == inputText) {
        alert('消息内容不能为空');
        return false;
    }

    var param = {
        openid: openid,
        content: inputText
    };

    var url = 'WXReceiveTextAct/sendMsg.act';
    var serverData = getDataFromServer(url, param);
    if (serverData) {
        var msg = getSendMsg4Text(inputText, timestamp, getNowFormatTime()); // 组装文本
        $("#messageList").append(msg); // 发送消息
        $("#editArea").html(''); // 清空内容
        document.getElementById(timestamp).scrollIntoView(); // 滚动条到最底部
    }
}

// 向上滚动加载
function selectList4TopScroll() {
    var param = {
        openid: openid,
        seqId: downSeqId
    };
    var url = 'WXReceiveTextAct/selectList.act';
    var serverData = getDataFromServer(url, param);
    if (serverData) {
        var tmpMsgId = null;
        var msglist = serverData.list;
        for (var i = 0; i < msglist.length; i++) {
            var msg = msglist[i];
            if (msg.fromusername == openid) { // 接收到的
                var msgHtml = getRespMsg(msg); // 组装文本
                $("#messageList").prepend(msgHtml); // 发送消息
                if (msg.ispush == 0) { // 未读消息
                    // 更改状态为已推送
                    var respData = getDataFromServer('WXReceiveTextAct/updateStatus.act?seqId=' + msg.seqId + '&openid=' + openid);
                    if (respData.retState == 0) {}
                }

            }
            if (msg.tousername == openid) { // 发出去的
                var msgHtml = '';
                if ('text' == msg.msgtype || 'template' == msg.msgtype) {
                    var tmpContent = (msg.content).replace(new RegExp("&lt;", "gm"), "<").replace(new RegExp("&gt;", "gm"), ">");
                    msgHtml = getSendMsg4Text(tmpContent, msg.msgid, msg.createtime, msg.userId); // 组装文本
                }
                if ('image' == msg.msgtype) {
                    msgHtml = getSendMsg4Image(msg); // 组装文本
                }

                if ('news' == msg.msgtype) {
                    msgHtml = getSendMsg4News(msg); // 组装文本
                }

                $("#messageList").prepend(msgHtml); // 发送消息
            }
            if (i == (msglist.length - 1)) { // 加载一次，最后面那条
                downSeqId = msg.seqId;
            }

            if (i == 0) {
                tmpMsgId = msg.msgid;
            }
        }

        // 加载完成，控制滚动条
        if (tmpMsgId) {
            // document.getElementById(tmpMsgId).scrollIntoView(); // 滚动条到最底部
        }

    }
}

/************************************************** websocket 相关 */
var websocket = null;
//判断当前浏览器是否支持WebSocket
if ('WebSocket' in window) {
    websocket = new WebSocket("ws://" + localhostPahtless + projectName + "/wechat4talk/" + openid + '*' + userseqid);
} else {
    alert('当前浏览器 Not support websocket')
}

//连接发生错误的回调方法
websocket.onerror = function() {
    // console.log("WebSocket连接发生错误");
};

//连接成功建立的回调方法
websocket.onopen = function() {
    // console.log("WebSocket连接成功");
}

//接收到消息的回调方法
websocket.onmessage = function(event) {
	setMessageInnerHTML(event.data);
}

//连接关闭的回调方法
websocket.onclose = function() {
    // console.log("WebSocket连接关闭");
}

//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
window.onbeforeunload = function() {
    closeWebSocket();
}

//强制关闭浏览器  调用websocket.close（）,进行正常关闭
window.onunload = function() {
    closeWebSocket();
}

//关闭WebSocket连接
function closeWebSocket() {
    websocket.close();
}

/************************************************** websocket 相关 */
var socketParam = {
    uri: "/wechat4talk/" + openid + '*' + userseqid,
    onMessage: function(event) {
        setMessageInnerHTML(event.data);
    }
};
// 创建对象
// var websocket = new KqdsWebSocket(socketParam); 
/************************************************** websocket 相关 end ... */
//将消息显示在网页上
function setMessageInnerHTML(data) {
    if (!isJSON(data)) {
        return false;
    }
    data = JSON.parse(data);

    var tmpContent = (data.content).replace(new RegExp("&lt;", "gm"), "<").replace(new RegExp("&gt;", "gm"), ">");
    // 展示
    respMsg(data);
    // 更改状态为已推送
    var respData = getDataFromServer('WXReceiveTextAct/updateStatus.act?seqId=' + data.seqId + '&openid=' + openid);
    if (respData.retState == 0) {}
}

/**
 * socket推送消息展示
 */
function respMsg(msgObj) {
    var msg = getRespMsg(msgObj); // 组装文本
    $("#messageList").append(msg); // 发送消息
    document.getElementById(msgObj.msgid).scrollIntoView(); // 滚动条到最底部
}
/**
 * 暂时只支持文本聊天
*/
function getRespMsg(msgObj) {
    var createtime = msgObj.createtime;
    if (!createtime) { // 如果没传参
        createtime = getNowFormatDate();
    }

    if (createtime.length > 19) { // 2017-10-11 15:16:00.283
        createtime = createtime.substring(0, 19);
    }

    var contentHtml = '';
    if (msgObj.msgtype == 'text') {
        var tmpContent = (msgObj.content).replace(new RegExp("&lt;", "gm"), "<").replace(new RegExp("&gt;", "gm"), ">");
        contentHtml = '<div class="plain"><pre>' + tmpContent + '</pre></div>';
    }
    if (msgObj.msgtype == 'image') {
        contentHtml = '<div class="picture"><img class="msg-img" src="' + msgObj.picurl + '" onclick="showImage(this);"></div>';
    }

    // 微信图标
    var tmp_headerimg = "../../static/image/kqdsFront/wechat/chat/user.jpg";
    if (fans_headimgurl) {
        tmp_headerimg = fans_headimgurl;
    }

    var msg = '';
    msg += '<div class="message" id="' + msgObj.msgid + '">';
    msg += '<img class="avatar" src="' + tmp_headerimg + '" />';
    msg += '<div class="content">';
    msg += '    <div class="nickname"><span class="time">' + createtime + '</span></div>';
    msg += '    <div class="bubble bubble_primary right no_arrow">';
    msg += '        <div class="bubble_cont">';
    msg += contentHtml;
    msg += '        </div>';
    msg += '    </div>';
    msg += '</div>';
    msg += '</div>';
    return msg;
}

/**
 * 发送图片
 */
function getSendMsg4News(imageObj) {
    var createtime = imageObj.createtime;
    if (createtime.length > 19) {
        createtime = createtime.substring(0, 19);
    }
    
    var userId = imageObj.userId;
    if(!userId){ // 如果不存在，则置空
    	userId = ''
    }else{
    	userId = userId + ' ';
    }

    var contentHtml = '<div class="news">';
    var newsItemList = imageObj.content.itemlist;
    if (!newsItemList) {
        // 此时imageObj.content是json字符串，不是Json对象
        var tmpObj = JSON.parse(imageObj.content);

        newsItemList = tmpObj.itemlist;
    }

    for (var i = 0; i < newsItemList.length; i++) {
        var newsItem = newsItemList[i];

        if (newsItemList.length == 1) {
            contentHtml += '<div class="newsItem" onclick="showNewsItem(\'' + newsItem.seqId + '\',\'' + newsItem.itemtype + '\',\'' + newsItem.url + '\');">';
            contentHtml += '<span class="newsTitle">' + newsItem.title + '</span>';
            contentHtml += '<div class="newsImg"><img src="' + contextPath + newsItem.imagepath + '"></div>';
            contentHtml += '<div class="newsgrey">' + newsItem.description + '</div>';
            contentHtml += '</div>';
        }
        if (newsItemList.length > 1) {
            contentHtml += '<div class="newsItem" >';
            if (i == 0) {
                contentHtml += '<div class="newsImg" style="position:relative"><img src="' + contextPath + newsItem.imagepath + '" onclick="showNewsItem(\'' + newsItem.seqId + '\',\'' + newsItem.itemtype + '\',\'' + newsItem.url + '\');">';
                contentHtml += '<div class="newsImgTitle" style="">' + newsItem.title + '</div></div>';
            } else {
                contentHtml += '<div style="overflow:hidden;border-top:1px solid #ddd; margin-top:5px;padding-top:5px;padding-bottom:5px;"  onclick="showNewsItem(\'' + newsItem.seqId + '\',\'' + newsItem.itemtype + '\',\'' + newsItem.url + '\');">';
                contentHtml += '<img style="float:right;width:50px;height:40px;" src="' + contextPath + newsItem.imagepath + '">';
                contentHtml += '<p style="height:40px;line-height:20px;font-size:13px;margin-right:50px;">' + newsItem.title + '</p>';
                contentHtml += '</div>';
            }
            contentHtml += '</div>';
        }
    }

    contentHtml += '</div>';

    var msg = '';
    msg += '<div class="message me" id="' + imageObj.msgid + '">';
    msg += '<img class="avatar" src="../../static/image/kqdsFront/wechat/chat/kqds.png" />';
    msg += '<div class="content">';
    msg += '    <div class="nickname"><span class="time">' + userId + createtime + '</span></div>';
    msg += '    <div class="bubble bubble_primary right no_arrow">';
    msg += '        <div class="bubble_cont">';
    msg += '            <div class="plain">';
    msg += contentHtml;
    msg += '            </div>';
    msg += '        </div>';
    msg += '    </div>';
    msg += '</div>';
    msg += '</div>';
    return msg;
}

/**
 * 暂时只支持文本聊天
*/
function getSendMsg4Text(inputText, timestamp, createtime, userId) {
    if (createtime.length > 19) { // 2017-10-11 15:16:00.283
        createtime = createtime.substring(0, 19);
    }
    
    if(!userId){ // 如果不存在，则置空
    	userId = ''
    }else{
    	userId = userId + ' ';
    }
    
    var contentHtml = '            	<pre>' + inputText + '</pre>';
    var msg = '';
    msg += '<div class="message me" id="' + timestamp + '">';
    msg += '<img class="avatar" src="../../static/image/kqdsFront/wechat/chat/kqds.png" />';
    msg += '<div class="content">';
    msg += '    <div class="nickname"><span class="time">' + userId + createtime + '</span></div>';
    msg += '    <div class="bubble bubble_primary right no_arrow">';
    msg += '        <div class="bubble_cont">';
    msg += '            <div class="plain">';
    msg += contentHtml;
    msg += '            </div>';
    msg += '        </div>';
    msg += '    </div>';
    msg += '</div>';
    msg += '</div>';
    return msg;
}

/**
 * 发送图片
 */
function getSendMsg4Image(imageObj) {
    var createtime = imageObj.createtime;
    if (createtime.length > 19) {
        createtime = createtime.substring(0, 19);
    }
    
    var userId = imageObj.userId;
    if(!userId){ // 如果不存在，则置空
    	userId = ''
    }else{
    	userId = userId + ' ';
    }
    
    var contentHtml = '<div class="picture"><img class="msg-img" src="' + imageObj.picurl + '" onclick="showImage(this);"></div>';
    var msg = '';
    msg += '<div class="message me" id="' + imageObj.msgid + '">';
    msg += '<img class="avatar" src="../../static/image/kqdsFront/wechat/chat/kqds.png" />';
    msg += '<div class="content">';
    msg += '    <div class="nickname"><span class="time">' + userId + createtime + '</span></div>';
    msg += '    <div class="bubble bubble_primary right no_arrow">';
    msg += '        <div class="bubble_cont">';
    msg += '            <div class="plain">';
    msg += contentHtml;
    msg += '            </div>';
    msg += '        </div>';
    msg += '    </div>';
    msg += '</div>';
    msg += '</div>';
    return msg;
}

function showImage(img) {
    var width = img.naturalWidth;
    var height = img.naturalHeight;
    var currentSrc = img.currentSrc;
    currentSrc = escape(currentSrc);

    var url = contextPath + '/wechat/chat/showImg.html?currentSrc=' + currentSrc;

    top.layer.open({
        type: 2,
        title: '大图展示',
        maxmin: true,
        shadeClose: true,
        //点击遮罩关闭层
        area: ['80%', '80%'],
        content: url
    });
}

function showNewsItem(newsItemSeqId, itemtype,outerUrl) {
    var url = contextPath + '/WXNewsItemAct/toDetail.act?seqId=' + newsItemSeqId;
    if(itemtype == 2){
    	url = outerUrl;
    }
    top.layer.open({
        type: 2,
        title: '图文详情',
        maxmin: true,
        shadeClose: true,
        //点击遮罩关闭层
        area: ['80%', '80%'],
        content: url
    });
}

// 快捷回复
function keywordSelect() {
    layer.open({
        type: 2,
        title: '快捷回复',
        maxmin: true,
        shadeClose: true,
        //点击遮罩关闭层
        area: ['90%', '50%'],
        content: contextPath + '/wechat/chat/keywordSelect.html'
    });
}
// 填充值
function inputKeywordValue(keyword) {
    $("#editArea").append(keyword);
    /* if ('' != $("#editArea").html()) {
        $('#btn_send').css("visibility","visible");
    } */
}

// 图文发送
function newsSelect() {
    layer.open({
        type: 2,
        title: '图文信息',
        maxmin: true,
        shadeClose: true,
        //点击遮罩关闭层
        area: ['90%', '50%'],
        content: contextPath + '/WXNewsAct/toSelect4chat.act?openid=' + openid
    });
}

//模板消息
function templateSelect() {
    layer.open({
        type: 2,
        title: '模板信息',
        maxmin: true,
        shadeClose: true,
        //点击遮罩关闭层
        area: ['90%', '90%'],
        content: contextPath + '/wechat/templateitem/send/index.html?openid=' + openid
    });
}

/**
 * 供子页面发送完成后调用
 */
function sendNewsMsg(newsMsgObj) {
    var itemHtml = getSendMsg4News(newsMsgObj);
    $("#messageList").append(itemHtml); // 发送消息
    document.getElementById(newsMsgObj.msgid).scrollIntoView(); // 滚动条到最底部
}

/**
 * 供子页面发送完成后调用
 */
function sendTemplateMsg(templateMsgObj) {
    var itemHtml = getSendMsg4Text(templateMsgObj.content, templateMsgObj.msgid, templateMsgObj.createtime);
    $("#messageList").append(itemHtml); // 发送消息
    document.getElementById(templateMsgObj.msgid).scrollIntoView(); // 滚动条到最底部
}
//编辑栏插入表情
$(function() {
    $("#editArea").focus(function() {
        //$("#editArea").removeClass("flag");
    });
    /* $("#myEditor").blur(function(){
		    	$("#myEditor").addClass("flag");
		     }); */
});

function add(html) {
    insertHTML(html);
}

//再加入一个全屏事件  
/* $(window).click(function(e) {
    if (window.getSelection) {
        var getevent = e.srcElement ? e.srcElement: e.target; //不要告诉我不知道这句的意思
        if (getevent.id != null && getevent.id == "cmdInsert" || getevent.id == "editArea") {
            //alert(0);
            //代表 点了插入html的按钮  
            //则不执行getFocus方法  
        } else $("#myEditor").addClass("flag"); //除非点了那个插入html的按钮 其他时候必须要执行getFocus来更新最后失去焦点的div  
    }
}) */

function insertHTML(html) {
    var dthis = $("#editArea")[0]; //要插入内容的某个div,在标准浏览器中 无需这句话  
    //dthis.focus();
    var sel, range;
    $("#editArea").focus();
    if (window.getSelection) {
        // IE9 and non-IE  
        sel = window.getSelection();
        console.dir(sel);

        if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();
            var el = document.createElement('div');
            el.innerHTML = html;
            var frag = document.createDocumentFragment(),
            node,
            lastNode;
            while ((node = el.firstChild)) {
                lastNode = frag.appendChild(node);
            }

            range.insertNode(frag);
            if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    } else if (document.selection && document.selection.type != 'Control') {
        $(dthis).focus(); //在非标准浏览器中 要先让你需要插入html的div 获得焦点  
        ierange = document.selection.createRange(); //获取光标位置  
        ierange.pasteHTML(html); //在光标位置插入html 如果只是插入text 则就是fus.text="..."  
        $(dthis).focus();

    }
}
</script>
</body>
</html>