<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link type="text/css" rel="stylesheet" href="css/base.css" />
		<link type="text/css" rel="stylesheet" href="../../../../plugin/layer-v2.4/layer/skin/layer.css" />
		
		<script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="../../../../plugin/layer-v2.4/layer/layer.js"></script>
		<script type="text/javascript" src="../../../../js/hudh/commont.js"></script>
		<script type="text/javascript" src="../../../../js/kqdsFront/util.js"></script>
		
		<style type="text/css">
			.plant_popup{
				/*border: 1px solid black;*/
			}
			.plant_popup>span{
				display: block;
				width: 100%;
				font-size: 18px;
				line-height: 34px;
				color: black;
				border-bottom: 1px solid black;
				padding-left: 10px;
				margin-bottom: 10px;
			}
			/*保存按钮*/
			.plant_popup>button{
				display: block;
				width: 80px;
				font-size: 14px;
				line-height: 30px;
				color: white;
				text-align: center;
				letter-spacing: 1px;
				background-color: #00a6c0;
				border: 0px;
				border-radius: 5px;
				margin:0px 0px 10px 80%;
				outline: none;
			}
			.plant_popup>div{
				display: flex;
				width: 100%;
				font-size: 14px;
				line-height: 30px;
				flex-direction: row;
				padding:5px 0px 0px 30px;
				margin-bottom: 10px;
				border: 1px solid #E5E5E5;
				box-sizing: border-box;
			}
			.plant_popup>div>span{
				display: block;
				width: 11%;
				letter-spacing: 1px;
			}
			.plant_popup>div>ul{
				display: flex;
				width: 89%;
				flex-direction: row;
				flex-wrap: wrap;
			}
			.plant_popup>div>ul>li{
				margin-right: 6%;
			}
			.plant_popup>div>ul>li>span{
				display: inline-block;
				padding: 0% 10px;
				border-radius: 5px;
				margin-bottom: 5px;
			}
			/*选中样式*/
			.plant_popup>div>ul>li>span.spanActive{
				background-color: #00a6c0;
				color: white;
			}
			/*种植系统，牙冠材质*/
			.plant_popup>.plant_system>ul>li,
			.plant_popup>.tooth_texture>ul>li{
				width: 27%;
			}
			/*临床路径*/
			.plant_popup>.clinic_way>ul>li{
				width: 44%;
			}
			.plant_popup>.clinic_way>ul>li>span{
				display: inline-block;
			}
		</style>
	</head>
	<body>
		<div class="plant_popup">
			<!--<span>提示</span>-->
			<!--项目类型-->
			<div class="project_type">
				<span>项目类型:</span>
				<ul valueNode="articleType">
					<li>
						<span class="spanActive" getValue="1" onclick="spanClickgetSingleVal(this)">种植</span>
					</li>
				</ul>
			</div>
			<!--跟踪方式-->
			<div class="tail_mode">
				<span>跟踪方式:</span>
				<ul valueNode="flowType">
					<li><span getValue="SingleOrMulti" onclick="spanClickgetSingleVal(this);showClinicWay(this);">局部种植</span></li>
					<li><span getValue="Locator" onclick="spanClickgetSingleVal(this);showClinicWay(this);">半口半固定</span></li>
					<li><span getValue="All-on-x" onclick="spanClickgetSingleVal(this);showClinicWay(this);">半口固定</span></li>
				</ul>
			</div>
			<!--上下颌-->
			<div class="top_bottom_jaw">
				<span>上&nbsp;&nbsp;下&nbsp;颌:</span>
				<ul valueNode="dentalJaw">
					<li><span getValue="1" onclick="spanClickgetSingleVal(this);showClinicWay(this);">上颌</span></li>
					<li><span getValue="2" onclick="spanClickgetSingleVal(this);showClinicWay(this);">下颌</span></li>
					<li><span getValue="0" onclick="spanClickgetSingleVal(this);showClinicWay(this);">全口</span></li>
					<!-- <li><span getValue="3" onclick="spanClickgetSingleVal(this);showClinicWay(this);">美牙</span></li>
					<li><span getValue="4" onclick="spanClickgetSingleVal(this);showClinicWay(this);">杆卡</span></li> -->
				</ul>
			</div>
			<div class="top_bottom_other">
				<span>其&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;他:</span>
				<ul valueNode="dentalOther">
					<li><span getValue="3" onclick="spanClickgetSingleVal(this);showClinicWay(this);">美牙</span></li>
					<li><span getValue="4" onclick="spanClickgetSingleVal(this);showClinicWay(this);">杆卡</span></li>
				</ul>
			</div>
			<!--种植系统-->
			<div class="plant_system">
				<span>种植系统:</span>
				<ul valueNode="plant_system">
					<li><span getValue="韩国Osstem种植体" onclick="spanClickgetMoreval(this)">韩国Osstem种植体</span></li>
					<li><span getValue="韩国Dentium种植体" onclick="spanClickgetMoreval(this)">韩国Dentium种植体</span></li>
					<li><span getValue="美国HIOSSEN种植体" onclick="spanClickgetMoreval(this)">美国HIOSSEN种植体</span></li>
					<li><span getValue="德国ICX种植体" onclick="spanClickgetMoreval(this)">德国ICX种植体</span></li>
					<li><span getValue="瑞典Nobel-Replace种植体" onclick="spanClickgetMoreval(this)">瑞典Nobel-Replace种植体</span></li>
					<li><span getValue="瑞典Nobel-Active种植体" onclick="spanClickgetMoreval(this)">瑞典Nobel-Active种植体</span></li>
					<li><span getValue="德国Camlog种植体" onclick="spanClickgetMoreval(this)">德国Camlog种植体</span></li>
					<li><span getValue="瑞典Nobel-PMC" onclick="spanClickgetMoreval(this)">瑞典Nobel-PMC</span></li>
					<li><span getValue="美国Zimmer" onclick="spanClickgetMoreval(this)">美国Zimmer</span></li>
					<li><span getValue="意大利B&B种植体" onclick="spanClickgetMoreval(this)">意大利B&B种植体</span></li>
					<li><span getValue="美国ET种植体" onclick="spanClickgetMoreval(this)">美国ET种植体</span></li>
				</ul>
			</div>
			<!--牙冠材质-->
			<!-- <div class="tooth_texture">
				<span>牙冠材质:</span>
				<ul valueNode="crown_material">
					<li><span getValue="局部-德国GEGO牙冠" onclick="spanClickgetMoreval(this)">局部-德国GEGO牙冠</span></li>
					<li><span getValue="局部-氧化锆牙冠" onclick="spanClickgetMoreval(this)">局部-氧化锆牙冠</span></li>
					<li><span getValue="局部-德国Weiland牙冠" onclick="spanClickgetMoreval(this)">局部-德国Weiland牙冠</span></li>
					<li><span getValue="局部-泽康全瓷牙冠" onclick="spanClickgetMoreval(this)">局部-泽康全瓷牙冠</span></li>
					<li><span getValue="局部-美国Lava牙冠" onclick="spanClickgetMoreval(this)">局部-美国Lava牙冠</span></li>
					<li><span getValue="局部-瑞典Procera牙冠" onclick="spanClickgetMoreval(this)">局部-瑞典Procera牙冠</span></li>
					<li><span getValue="半口-可摘型德国GEGO牙桥" onclick="spanClickgetMoreval(this)">半口-可摘型德国GEGO牙桥</span></li>
					<li><span getValue="半口-可摘型维他灵牙桥" onclick="spanClickgetMoreval(this)">半口-可摘型维他灵牙桥</span></li>
					<li><span getValue="半口-可摘型纯钛牙桥" onclick="spanClickgetMoreval(this)">半口-可摘型纯钛牙桥</span></li>
					<li><span getValue="半口-固定版树脂牙桥" onclick="spanClickgetMoreval(this)">半口-固定版树脂牙桥</span></li>
					<li><span getValue="半口-固定版氧化锆牙桥" onclick="spanClickgetMoreval(this)">半口-固定版氧化锆牙桥</span></li>
				</ul>
			</div> -->
			<!--临床路径-->
			<div class="clinic_way">
				<span>临床路径:</span>
				<ul id="clinic_way" valueNode="flowcode">
				</ul>
			</div>
			<button onclick="buttonSave()">保存</button>
		</div>
		
		<script type="text/javascript">
			var apppath = apppath();
			var id = getUrlParam("id");
			var datalist={}; //对象
			datalist["articleType"]="1";//目前只有种植，传后台的值为标签自定义属性getValue的值
			//获取url中的参数
			function getUrlParam(name) {
			    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
			    var r = window.location.search.substr(1).match(reg);  //匹配目标参数
			    if (r != null) return unescape(r[2]); 
			    return null; //返回参数值
			}
//			单选
			function spanClickgetSingleVal(obj){
				var valNode=$(obj).parent().parent().attr("valueNode");//节点值类型
				/* 美牙杆卡单独判断 */
				if(valNode=='dentalOther'){
					var dentalOtherList=$("ul[valueNode='dentalOther']").find("span");
					if($(obj).hasClass("spanActive")){
						$(obj).removeClass("spanActive");
						datalist[valNode]=null; //判断根据样式来取值
					}else{
						for (var i = 0; i < dentalOtherList.length; i++) {
							dentalOtherList.eq(i).removeClass("spanActive");
						} 
						$(obj).addClass("spanActive");
						datalist[valNode]=$(obj).attr("getValue");//判断根据样式来取值
					}
				}else{
					var spanBrother=$(obj).parent().parent().find("li").find("span");
					for (var i = 0; i < spanBrother.length; i++) {
						spanBrother.eq(i).removeClass("spanActive");
					}  
					$(obj).addClass("spanActive");//添加背景样式 
				}
				var spanSelfVal=$(obj).attr("getValue");//当前选中的值
				var valNodeList=$("ul[valueNode="+valNode+"]").find("span");
				for(var v=0;v<valNodeList.length;v++){
					if(valNodeList.eq(v).hasClass("spanActive")){
						datalist[valNode]=valNodeList.eq(v).attr("getValue");//判断根据样式来取值
					}
				}
//				console.log(JSON.stringify(datalist));
			};
//			多选
			function spanClickgetMoreval(obj){
				$(obj).toggleClass("spanActive");//添加背景样式
				var valNode=$(obj).parent().parent().attr("valueNode");//节点值类型
				var spanSelfVal=$(obj).attr("getValue");//当前选中的值	
				if(!datalist[valNode]){
					datalist[valNode]=[];
				}
				
				if($(obj).hasClass("spanActive")){
					if(datalist[valNode].indexOf(spanSelfVal)==-1){
						datalist[valNode].push(spanSelfVal);
					}
				}else{
					var thisValIndex=datalist[valNode].indexOf(spanSelfVal);
					datalist[valNode].splice(thisValIndex,1);
				}
			};
//			查询临床路径方法
			function showClinicWay(obj){
				var articleType = datalist["articleType"];
				var flowType = datalist["flowType"];
				var dentalJaw = datalist["dentalJaw"];
				var dentalOther = datalist["dentalOther"];//美牙杆卡
//				alert(dentalJaw);
//				console.log(dentalJaw instanceof Number);
//				console.log(dentalOther+"--------美牙杆卡");
				if( dentalOther == 3 || dentalOther == 4) {
					 $.ajax({
						url: apppath + "/HUDH_FlowConfigAct/findLcljFlowInforByDentalJaw.act",
						type:"POST",
						dataType:"json",
						async: true,
						data:{
							"articleType":articleType,
							"flowType":flowType,
							"dentalJaw":dentalOther
						},
						success:function(data){
							var ClinicWayHtml="";
							for (var i = 0; i < data.length; i++) {
								ClinicWayHtml+='<li><span getValue='+data[i].flowcode+' onclick="spanClickgetSingleVal(this)">'+data[i].flowname+'</span></li>';
							}
							$("#clinic_way").html(ClinicWayHtml);
						}
					});  
				} else {
					$.ajax({
						url: apppath + "/HUDH_FlowConfigAct/findLcljFlowByDentalJaw.act",
						type:"POST",
						dataType:"json",
						async: true,
						data:{
							"articleType":articleType,
							"flowType":flowType,
							"dentalJaw":dentalJaw
						},
						success:function(data){
							//console.log(data[0].flowname);
							var ClinicWayHtml="";
							for (var i = 0; i < data.length; i++) {
								ClinicWayHtml+='<li><span getValue='+data[i].flowcode+' onclick="spanClickgetSingleVal(this)">'+data[i].flowname+'</span></li>';
							}
							$("#clinic_way").html(ClinicWayHtml);
						}
					}); 
				}
			};
//			点击保存按钮方法
			function buttonSave(){
//				console.log(datalist);
//				console.log(datalist["articleType"]);
				if(datalist["flowType"]==null){
					layer.alert("请选择跟踪方式!")
					return;
				}else if(datalist["dentalJaw"]==null){
					layer.alert("请选择上下颌!")
					return;
				}else if(datalist["plant_system"]==null||datalist["plant_system"].length==0){
					layer.alert("请选择种植系统!")
					return;
				}else if(datalist["flowcode"]==null){
					layer.alert("请选择临床路径!")
					return;
				}
				$.ajax({
					type:"post",
					url: apppath + "/HUDH_FlowAct/updateOrderTrackNodes.act",
					dataType:"json",
					traditional: true,//属性在这里设置
					async:true,
					data:{
						"articleType":datalist["articleType"],
						"flowType":datalist["flowType"],
						"dentalJaw":datalist["dentalJaw"],
						"plant_system":datalist["plant_system"],
						"flowcode":datalist["flowcode"],
						/* "crown_material":datalist["crown_material"], */
						"id" : id
					},
					success:function(result){
						if (result.retState == "0") {
							layer.alert('提交成功', function() {
								window.parent.location.reload(); //刷新父页面
				                var frameindex = parent.layer.getFrameIndex(window.name);
				                parent.layer.close(frameindex); //再执行关闭
							});
				        } else {
					        layer.alert('提交失败：' + result.retMsrg, {//后台抛出的异常信息在前台展示
					            end: function() {
					            	window.parent.location.reload(); //刷新父页面
					                var frameindex = parent.layer.getFrameIndex(window.name);
					                parent.layer.close(frameindex); //再执行关闭
					            }
					        });
				        }
					}
				});
			};
		</script>
	</body>
</html>
